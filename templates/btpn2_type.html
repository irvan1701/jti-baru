{% extends 'sidebar.html' %}
{% block title %}{{ chiller_name or 'Chiller Dashboard' }} - JTI BAS Dashboard{% endblock %}

{% block header_title %}{{ chiller_name or 'Chiller Dashboard' }}{% endblock %}

{% block content %}
<div class="chiller-content-wrapper">
    <div class="dashboard-grid">
        
        
        <div class="last-updated-info">
            <p>Last Updated: {{ last_updated_timestamp.strftime("%Y-%m-%d %H:%M:%S") if last_updated_timestamp else 'N/A' }}</p>
            <div class="unit-selection">
                <label for="temp_unit">Temperature Unit:</label>
                <select id="temp_unit">
                    <option value="celsius">Celsius (°C)</option>
                    <option value="fahrenheit">Fahrenheit (°F)</option>
                </select>
            </div>
        </div>

        <div class="faults-section">
            
            <div class="fault-card {% if data.safety_fault and data.safety_fault > 0 %}blink-red{% endif %}">
                <div class="icon-circle"><img src="{{ url_for('static', filename='icons/shield-icon.png') }}" alt="Safety Fault"></div>
                <div class="fault-details"><p class="fault-type">Safety Fault</p><p class="fault-value">{{ data.safety_fault_desc if data and data.safety_fault_desc is not none else '-' }}</p></div>
            </div>
            <div class="fault-card {% if data.cycling_fault and data.cycling_fault > 0 %}blink-yellow{% endif %}">
                <div class="icon-circle"><img src="{{ url_for('static', filename='icons/cycling-icon.png') }}" alt="Cycling Fault"></div>
                <div class="fault-details"><p class="fault-type">Cycling Fault</p><p class="fault-value">{{ data.cycling_fault_desc if data and data.cycling_fault_desc is not none else '-' }}</p></div>
            </div>
            <div class="fault-card {% if data.warning_fault and data.warning_fault > 0 %}blink-yellow{% endif %}">
                <div class="icon-circle"><img src="{{ url_for('static', filename='icons/bell-icon.png') }}" alt="Warning Fault"></div>
                <div class="fault-details"><p class="fault-type">Warning Fault</p><p class="fault-value">{{ data.warning_fault_desc if data and data.warning_fault_desc is not none else '-' }}</p></div>
            </div>
        </div>

        <div class="chiller-details-section">
            <div class="chiller-image">
                {% if data and data.fla is not none and data.fla > 5 %}
                <img src="{{ url_for('static', filename='images/chiller-active.gif') }}" alt="Chiller Unit">
                {% else %}
                <img src="{{ url_for('static', filename='images/chiller.png') }}" alt="Chiller Unit">
                {% endif %}
            </div>
           <div class="chiller-info-grid">
                <div class="info-card"><p class="label">Status</p><p class="value running">{{ "Running" if data and data.fla is not none and data.fla > 5 else "Stopped" }}</p></div>
                <div class="info-card"><p class="label">FLA</p><p class="value">{{ data.fla if data and data.fla is not none else '-' }} %</p></div>
                <div class="info-card"><p class="label">Operating Hour</p><p class="value">{{ data.operating_hour if data and data.operating_hour is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Input Power</p><p class="value">{{ data.input_power if data and data.input_power is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Input KWh</p><p class="value">{{ data.input_kwh if data and data.input_kwh is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">VSD Out voltage</p><p class="value">{{ data.vsd_out_voltage if data and data.vsd_out_voltage is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Motor PH A Current</p><p class="value">{{ data.Motor_Ph_A_Current if data and data.Motor_Ph_A_Current is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Motor PH B Current</p><p class="value">{{ data.Motor_Ph_B_Current if data and data.Motor_Ph_B_Current is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Motor PH C Current</p><p class="value">{{ data.Motor_Ph_C_Current if data and data.Motor_Ph_C_Current is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Approach Evap</p><p class="value">{{ data.Approach_Evap if data and data.Approach_Evap is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Approach Cond</p><p class="value">{{ data.Approach_Cond if data and data.Approach_Cond is not none else '-' }}</p></div>

                <div class="info-card"><p class="label">Evap ΔT</p><p class="value">{{ data.Evap_DT if data and data.Evap_DT is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Cond ΔT</p><p class="value">{{ data.Cond_DT if data and data.Cond_DT is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Cooling Capacity</p><p class="value">{{ data.Cooling_Capacity if data and data.Cooling_Capacity is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Efficiency</p><p class="value">{{ data.efficiency if data and data.efficiency is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">COP</p><p class="value">{{ data.COP if data and data.COP is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">EER</p><p class="value">{{ data.EER if data and data.EER is not none else '-' }}</p></div>
            </div>
        </div>

        

        <div class="evap-cond-section">
            <div class="section-card">
                <p class="mb-4">Evap</p>
                <div class="flex flex-row space-x-4">
                    <div class="thermometer-group flex-1 flex flex-row space-x-4">
                        <div class="single-thermometer">
                            <p class="thermometer-label">LWT</p>
                            <canvas data-type="linear-gauge" data-min-value="10" data-max-value="80" data-major-ticks="10, 20, 30, 40, 50, 60, 70, 80" data-width="120" data-height="220" data-value="{{ data.evap_lwt if data and data.evap_lwt is not none else 0 }}" data-units="°C" data-original-value="{{ data.evap_lwt if data and data.evap_lwt is not none else 0 }}"></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">RWT</p>
                            <canvas data-type="linear-gauge" data-min-value="10" data-max-value="80" data-major-ticks="10, 20, 30, 40, 50, 60, 70, 80" data-width="120" data-height="220" data-value="{{ data.evap_rwt if data and data.evap_rwt is not none else 0 }}" data-units="°C" data-original-value="{{ data.evap_rwt if data and data.evap_rwt is not none else 0 }}" data-min-value="0" data-max-value="60"></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Satur Temp</p>
                            <canvas data-type="linear-gauge" data-min-value="0" data-max-value="80" data-major-ticks="0, 10, 20, 30, 40, 50, 60, 70, 80" data-width="120" data-height="220" data-value="{{ data.cond_satur_temp if data and data.cond_satur_temp is not none else 0 }}" data-units="°C" data-original-value="{{ data.cond_satur_temp if data and data.cond_satur_temp is not none else 0 }}"></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Pressure</p>
                            <canvas data-type="radial-gauge" data-min-value="230" data-max-value="520" data-major-ticks="230, 250, 280, 330, 380, 430, 480, 520" data-width="180" data-height="180" data-value="{{ data.evap_pressure if data and data.evap_pressure is not none else 0 }}" data-units="psi"></canvas>
                        </div>
                    </div>
                    <div class="data-table-container flex-1 p-4 rounded-md shadow-sm">
                        <h3 class="text-lg font-semibold mb-2 text-center">Detail Evaporator</h3>
                        <table class="parameter-table min-w-full">
                            <thead>
                                <tr>
                                    <th scope="col">Parameter</th>
                                    <th scope="col">Safe Range</th>
                                    <th scope="col">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">LWT</td>
                                    <td>-</td>
                                    <td data-temp-celsius="{{ data.evap_lwt if data and data.evap_lwt is not none else 0 }}">{{ data.evap_lwt if data and data.evap_lwt is not none else '-' }} °C</td>
                                </tr>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">RWT</td>
                                    <td>-</td>
                                    <td data-temp-celsius="{{ data.evap_rwt if data and data.evap_rwt is not none else 0 }}">{{ data.evap_rwt if data and data.evap_rwt is not none else '-' }} °C</td>
                                </tr>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Satur Temp</td>
                                    <td>-</td>
                                    <td data-temp-celsius="{{ data.cond_satur_temp if data and data.cond_satur_temp is not none else 0 }}">{{ data.cond_satur_temp if data and data.cond_satur_temp is not none else '-' }} °C</td>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Pressure</td>
                                    <td>-</td>
                                    <td>{{ data.evap_pressure if data and data.evap_pressure is not none else '-' }} psi</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <p class="mb-4">Condenser</p>
                <div class="flex flex-row space-x-4">
                    <div class="thermometer-group flex-1 flex flex-row space-x-4">
                        <div class="single-thermometer">
                            <p class="thermometer-label">LWT</p>
                            <canvas data-type="linear-gauge" data-width="120" data-height="220" data-value="{{ data.cond_lwt if data and data.cond_lwt is not none else 0 }}" data-units="°C" data-original-value="{{ data.cond_lwt if data and data.cond_lwt is not none else 0 }}"></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">RWT</p>
                            <canvas data-type="linear-gauge" data-width="120" data-height="220" data-value="{{ data.cond_rwt if data and data.cond_rwt is not none else 0 }}" data-units="°C" data-original-value="{{ data.cond_rwt if data and data.cond_rwt is not none else 0 }}"></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Satur Temp</p>
                            <canvas data-type="linear-gauge" data-min-value="10" data-max-value="105" data-major-ticks="10, 20, 30, 40, 50, 60, 70, 80,90, 105" data-width="120" data-height="220" data-value="{{ data.cond_satur_temp if data and data.cond_satur_temp is not none else 0 }}" data-units="°C" data-original-value="{{ data.cond_satur_temp if data and data.cond_satur_temp is not none else 0 }}"></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Pressure</p>
                            <canvas data-type="radial-gauge" data-width="180" data-min-value="0" data-max-value="900" data-major-ticks="0, 100, 200, 300, 400, 500, 600, 700, 800, 900" data-height="180" data-value="{{ data.cond_pressure if data and data.cond_pressure is not none else 0 }}" data-units="psi"></canvas>
                        </div>
                    </div>
                    <div class="data-table-container flex-1 p-4 rounded-md shadow-sm">
                        <h3 class="text-lg font-semibold mb-2 text-center">Detail Kondensor</h3>
                        <table class="parameter-table min-w-full">
                            <thead>
                                <tr>
                                    <th scope="col">Parameter</th>
                                    <th scope="col">Safe Range</th>
                                    <th scope="col">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">LWT</td>
                                    <td>-</td>
                                    <td data-temp-celsius="{{ data.cond_lwt if data and data.cond_lwt is not none else 0 }}">{{ data.cond_lwt if data and data.cond_lwt is not none else '-' }} °C</td>
                                </tr>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">RWT</td>
                                    <td>-</td>
                                    <td data-temp-celsius="{{ data.cond_rwt if data and data.cond_rwt is not none else 0 }}">{{ data.cond_rwt if data and data.cond_rwt is not none else '-' }} °C</td>
                                </tr> 
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Satur Temp</td>
                                    <td>-</td>
                                    <td data-temp-celsius="{{ data.cond_satur_temp if data and data.cond_satur_temp is not none else 0 }}">{{ data.cond_satur_temp if data and data.cond_satur_temp is not none else '-' }} °C</td>
                                </tr>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Pressure</td>
                                    <td>-</td>
                                    <td>{{ data.cond_pressure if data and data.cond_pressure is not none else '-' }} psi</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="oil-discharge-section">
            <div class="section-card">
                <p class="mb-4">Oil & Discharge</p>
                 <div class="flex flex-row space-x-4">
                    <div class="thermometer-group flex-1 flex flex-row space-x-4">
                        <div class="single-thermometer">
                            <p class="thermometer-label">Oil Pressure Diff</p>
                            <canvas data-type="radial-gauge" data-min-value="-5" data-max-value="300" data-major-ticks="-5, 30, 65, 100, 135, 170, 205, 240, 275, 300" data-width="180" data-height="180" data-value="{{ data.oil_pressure_diff if data and data.oil_pressure_diff is not none else 0 }}" data-units="psi"></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Oil Pump Pressure</p>
                            <canvas data-type="radial-gauge" min-value="0" data-max-value="1000" data-major-ticks="0, 100, 200, 300, 400, 500, 600, 700, 800, 900, 1000" data-width="180" data-height="180" data-value="{{ data.oil_pump_pressure if data and data.oil_pump_pressure is not none else 0 }}" data-units="psi"></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Oil Sump Temp</p>
                            <canvas data-type="linear-gauge" data-min-value="0" data-max-value="125" data-major-ticks="0, 15, 30, 45, 60, 75, 90, 105, 120, 125" data-width="120" data-height="220" data-value="{{ data.oil_sump_temp if data and data.oil_sump_temp is not none else 0 }}" data-units="°C" data-original-value="{{ data.oil_sump_temp if data and data.oil_sump_temp is not none else 0 }}"></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Discharge Temp</p>
                            
                            <canvas data-type="linear-gauge" data-min-value="0" data-max-value="120" data-major-ticks="0, 12, 24, 36, 48, 60, 72, 84, 96, 108, 120" data-width="120" data-height="220" data-value="{{ data.discharge_temp if data and data.discharge_temp is not none else 0 }}" data-units="°C" data-original-value="{{ data.discharge_temp if data and data.discharge_temp is not none else 0 }}" data-min-value="0" data-max-value="120"></canvas>
                        </div>
                    </div>
                    <div class="data-table-container flex-1 p-4 rounded-md shadow-sm">
                        <h3 class="text-lg font-semibold mb-2 text-center">Detail Oli & Discharge</h3>
                        <table class="parameter-table min-w-full">
                            <thead>
                                <tr>
                                    <th scope="col">Parameter</th>
                                    <th scope="col">Safe Range</th>
                                    <th scope="col">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Oil Pressure Diff</td>
                                    <td>-</td>
                                    <td>{{ data.oil_pressure_diff if data and data.oil_pressure_diff is not none else '-' }} psi</td>
                                </tr>
                                 <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Oil Pump Pressure</td>
                                    <td>-</td>
                                    <td>{{ data.oil_pump_pressure if data and data.oil_pump_pressure is not none else '-' }} psi</td>
                                </tr>
                                 <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Oil Sump Temp</td>
                                    <td>-</td>
                                    <td data-temp-celsius="{{ data.oil_sump_temp if data and data.oil_sump_temp is not none else 0 }}">{{ data.oil_sump_temp if data and data.oil_sump_temp is not none else '-' }} °C</td>
                                </tr>
                                 <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Discharge Temp</td>
                                    <td>-</td>
                                    <td data-temp-celsius="{{ data.discharge_temp if data and data.discharge_temp is not none else 0 }}">{{ data.discharge_temp if data and data.discharge_temp is not none else '-' }} °C</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="chart-section">
            <h2 class="text-2xl font-bold text-white mb-4 text-center">Analisis Data Historis</h2>
            
            <form action="{{ url_for('test') }}" method="get">
                <input type="hidden" name="chiller_id" value="{{ chiller.id }}">
                <div class="filter-form">
                    <div>
                        <label for="start_date">Dari Tanggal & Jam</label>
                        <input type="datetime-local" id="start_date" name="start_date" value="{{ start_date or '' }}">
                    </div>
                    <div>
                        <label for="end_date">Sampai Tanggal & Jam</label>
                        <input type="datetime-local" id="end_date" name="end_date" value="{{ end_date or '' }}">
                    </div>
                    <button type="submit">Tampilkan</button>
                </div>
            </form>

            {% if historical_data %}
            <div class="charts-grid">
                {% set parameters = [
                    { "key": "evap_lwt", "label": "Evap LWT", "unit": "°C" },
                    { "key": "evap_rwt", "label": "Evap RWT", "unit": "°C" },
                    { "key": "evap_pressure", "label": "Evap Pressure", "unit": "kPa" },
                    { "key": "evap_satur_temp", "label": "Evap Sat. Temp", "unit": "°C" },
                    { "key": "cond_lwt", "label": "Cond LWT", "unit": "°C" },
                    { "key": "cond_rwt", "label": "Cond RWT", "unit": "°C" },
                    { "key": "cond_pressure", "label": "Cond Pressure", "unit": "kPa" },
                    { "key": "cond_satur_temp", "label": "Cond Sat. Temp", "unit": "°C" },
                    { "key": "fla", "label": "FLA", "unit": "%" },
                    { "key": "input_power", "label": "Input Power", "unit": "kW" },
                    { "key": "vsd_out_voltage", "label": "VSD Output Voltage", "unit": "V" },
                    { "key": "oil_sump_temp", "label": "Oil Sump Temp", "unit": "°C" },
                    { "key": "discharge_temp", "label": "Discharge Temp", "unit": "°C" },
                    { 
                        "key": "motor_currents", 
                        "label": "Motor Phase Currents", 
                        "unit": "A",
                        "datasets": [
                            { "key": "Motor_Ph_A_Current", "label": "Phase A", "borderColor": "#3498db" },
                            { "key": "Motor_Ph_B_Current", "label": "Phase B", "borderColor": "#e74c3c" },
                            { "key": "Motor_Ph_C_Current", "label": "Phase C", "borderColor": "#2ecc71" }
                        ]
                    }
                ] %}

                {% for param in parameters %}
                <div class="chart-card-wrapper">
                    <div class="chart-card">
                        <h3 class="chart-card-title">{{ param.label }}</h3>
                        <div class="chart-canvas-container">
                            <canvas id="chart-{{ param.key }}"></canvas>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center">
                <h3 class="text-xl font-semibold text-white">Data Grafik Tidak Tersedia</h3>
                <p class="text-gray-400 mt-2">Tidak ada data historis yang ditemukan untuk rentang waktu ini.</p>
            </div>
            {% endif %}
        </div>

    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const historicalData = {{ historical_data|tojson }};
        const parameters = {{ parameters | tojson }};
        let currentCharts = {}; // To store chart instances for destruction

        const tempUnitSelect = document.getElementById('temp_unit');
        
        // Load saved unit preference or default to Celsius
        let currentUnit = localStorage.getItem('temperatureUnit') || 'celsius';
        tempUnitSelect.value = currentUnit;

        // Helper function to convert Celsius to Fahrenheit
        function celsiusToFahrenheit(celsius) {
            if (celsius === null || celsius === undefined || isNaN(celsius)) {
                return null;
            }
            return (celsius * 9/5) + 32;
        }

        // Function to update all temperature displays (gauges and tables)
        function updateTemperatureDisplays(unit) {
            const tempElements = document.querySelectorAll('[data-temp-celsius]');
            tempElements.forEach(el => {
                const celsiusValue = parseFloat(el.dataset.tempCelsius);
                let displayValue = '-';
                let displayUnit = '';

                if (!isNaN(celsiusValue)) {
                    if (unit === 'fahrenheit') {
                        displayValue = celsiusToFahrenheit(celsiusValue).toFixed(2);
                        displayUnit = '°F';
                    } else {
                        displayValue = celsiusValue.toFixed(2);
                        displayUnit = '°C';
                    }
                }
                el.textContent = `${displayValue} ${displayUnit}`;
            });

            // Update gauges using the canvas-gauges API
            document.gauges.forEach(gauge => {
                // Only update gauges that are temperature related (linear-gauges in this case)
                if (gauge.canvas.element.dataset.type !== 'linear-gauge') {
                    return;
                }

                const canvas = gauge.canvas.element;
                const originalValue = parseFloat(canvas.dataset.originalValue);
                // Use the data attributes for min/max, fallback to gauge options or defaults
                const originalMin = parseFloat(canvas.dataset.minValue || gauge.options.minValue || 0);
                const originalMax = parseFloat(canvas.dataset.maxValue || gauge.options.maxValue || 100);

                let newOptions = {};

                if (unit === 'fahrenheit') {
                    newOptions.value = celsiusToFahrenheit(originalValue);
                    newOptions.units = '°F';
                    newOptions.minValue = celsiusToFahrenheit(originalMin);
                    newOptions.maxValue = celsiusToFahrenheit(originalMax);
                } else {
                    newOptions.value = originalValue;
                    newOptions.units = '°C';
                    newOptions.minValue = originalMin;
                    newOptions.maxValue = originalMax;
                }
                
                // Also update the major ticks for the new range
                const newMajorTicks = [];
                const range = newOptions.maxValue - newOptions.minValue;
                const step = range / 5; // Example: 5 steps
                for (let i = 0; i <= 5; i++) {
                    newMajorTicks.push(parseFloat((newOptions.minValue + i * step).toFixed(1)));
                }
                newOptions.majorTicks = newMajorTicks;

                gauge.update(newOptions);
            });
        }

        function renderCharts() {
            // Destroy existing charts before re-rendering
            for (const chartId in currentCharts) {
                if (currentCharts[chartId]) {
                    currentCharts[chartId].destroy();
                }
            }
            currentCharts = {}; // Clear the object

            if (historicalData && historicalData.length > 0) {
                const labels = historicalData.map(d => new Date(d.timestamp).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'medium' }));
                
                parameters.forEach(param => {
                    const ctx = document.getElementById(`chart-${param.key}`)?.getContext('2d');
                    if (!ctx) return;

                    let datasets;
                    const isTemperature = ["evap_lwt", "evap_rwt", "evap_satur_temp", "cond_lwt", "cond_rwt", "cond_satur_temp", "oil_sump_temp", "discharge_temp", "Motor_Ph_A_Current", "Motor_Ph_B_Current", "Motor_Ph_C_Current"].includes(param.key);
                    let displayUnit = param.unit;

                    if (isTemperature && currentUnit === 'fahrenheit') {
                        displayUnit = '°F';
                    } else if (isTemperature && currentUnit === 'celsius') {
                        displayUnit = '°C';
                    }

                    if (param.datasets) {
                        // Multi-dataset chart (e.g., Motor Phase Currents)
                        datasets = param.datasets.map((ds) => {
                            const r = parseInt(ds.borderColor.slice(1, 3), 16);
                            const g = parseInt(ds.borderColor.slice(3, 5), 16);
                            const b = parseInt(ds.borderColor.slice(5, 7), 16);
                            const gradient = ctx.createLinearGradient(0, 0, 0, 250);
                            gradient.addColorStop(0, `rgba(${r}, ${g}, ${b}, 0.4)`);
                            gradient.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0)`);

                            return {
                                label: `${ds.label}`,
                                data: historicalData.map(d => {
                                    const value = d[ds.key];
                                    return isTemperature && currentUnit === 'fahrenheit' ? celsiusToFahrenheit(value) : value;
                                }),
                                borderColor: ds.borderColor,
                                backgroundColor: gradient,
                                borderWidth: 2,
                                pointRadius: 2,
                                pointHoverRadius: 5,
                                pointBackgroundColor: ds.borderColor,
                                fill: true,
                                tension: 0.4
                            };
                        });
                    } else {
                        // Single-dataset chart
                        const gradient = ctx.createLinearGradient(0, 0, 0, 250);
                        gradient.addColorStop(0, 'rgba(234, 179, 8, 0.4)');
                        gradient.addColorStop(1, 'rgba(234, 179, 8, 0)');
                        
                        datasets = [{
                            label: param.label,
                            data: historicalData.map(d => {
                                const value = d[param.key];
                                return isTemperature && currentUnit === 'fahrenheit' ? celsiusToFahrenheit(value) : value;
                            }),
                            borderColor: '#eab308',
                            backgroundColor: gradient,
                            borderWidth: 2,
                            pointRadius: 2,
                            pointHoverRadius: 5,
                            pointBackgroundColor: '#eab308',
                            fill: true,
                            tension: 0.4
                        }];
                    }

                    currentCharts[param.key] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    display: !!param.datasets,
                                    position: 'top',
                                    labels: {
                                        color: '#d1d5db',
                                        boxWidth: 12,
                                        padding: 20,
                                        font: {
                                            size: 14
                                        }
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    backgroundColor: '#1f2937',
                                    titleColor: '#d1d5db',
                                    bodyColor: '#d1d5db',
                                    cornerRadius: 8,
                                    padding: 12,
                                    titleFont: { weight: 'bold' },
                                    bodyFont: { size: 14 },
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += context.parsed.y.toFixed(2) + ' ' + displayUnit;
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { 
                                    ticks: { 
                                        display: true, 
                                        autoSkip: true,
                                        maxTicksLimit: 7,
                                        color: '#9ca3af'
                                    },
                                    grid: { display: false }
                                },
                                y: {
                                    beginAtZero: false,
                                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                                    ticks: { 
                                        color: '#9ca3af',
                                        maxTicksLimit: 5,
                                        callback: function(value) {
                                            return value.toFixed(2) + ' ' + displayUnit;
                                        }
                                    }
                                }
                            }
                        }
                    });
                });
            }
        }

        // Initial render of charts and temperature displays
        renderCharts();
        updateTemperatureDisplays(currentUnit);

        // Event listener for unit change
        tempUnitSelect.addEventListener('change', function() {
            currentUnit = this.value;
            localStorage.setItem('temperatureUnit', currentUnit);
            updateTemperatureDisplays(currentUnit);
            renderCharts(); // Re-render charts with new unit
        });
    });
</script>
{% endblock %}
