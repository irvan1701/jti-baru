{% extends 'sidebar.html' %}

{% block title %}{{ chiller_name or 'Chiller Dashboard' }} - JTI BAS Dashboard{% endblock %}

{% block header_title %}{{ chiller_name or 'Chiller Dashboard' }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
  .value-cell.safe {
    color: #2ecc71; /* Green */
    font-weight: bold;
  }
  .value-cell.unsafe {
    color: #e74c3c; /* Red */
    font-weight: bold;
  }
  .icon-circle i {
    font-size: 24px;
    color: #fff;
  }
  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
  .modal-content { background-color: #2d3748; color: #e2e8f0; margin: 15% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; text-align: center; position: relative; }
  .close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; }
  .close-button:hover, .close-button:focus { color: #fff; text-decoration: none; cursor: pointer; }
  .modal-buttons button { background-color: #4a5568; color: white; padding: 12px 24px; margin: 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
  .modal-buttons button:hover { background-color: #5a6578; }
</style>
<div class="chiller-content-wrapper">
    <div class="dashboard-grid">
        <div class="last-updated-info">
            <p>Last Updated: {{ last_updated_timestamp.strftime("%Y-%m-%d %H:%M:%S") if last_updated_timestamp else 'N/A' }}</p>
            <div class="unit-selection">
                <label for="temp_unit">Temperature Unit:</label>
                <select id="temp_unit">
                    <option value="celsius">Celsius (°C)</option>
                    <option value="fahrenheit">Fahrenheit (°F)</option>
                </select>
            </div>
        </div>
        
        <div class="faults-section">
            <div class="fault-card">
                <div class="icon-circle"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="fault-details"><p class="fault-type">Chiller Alarm</p><p class="fault-value">{{ data.Chiller_Alarm if data and data.Chiller_Alarm is not none else '-' }}</p></div>
            </div>
            <div class="fault-card">
                <div class="icon-circle"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="fault-details"><p class="fault-type">Fault Code</p><p class="fault-value">{{ data.Fault_Code if data and data.Fault_Code is not none else '-' }}</p></div>
            </div>
        </div>

        <div class="chiller-details-section">
            <div class="chiller-image">
                {% if data and data.Sys1_Comp_FLA is not none and data.Sys1_Comp_FLA > 5 %}
                <img src="{{ url_for('static', filename='images/chiller-active.gif') }}" alt="Chiller Unit">
                {% else %}
                <img src="{{ url_for('static', filename='images/chiller.png') }}" alt="Chiller Unit">
                {% endif %}
            </div>
            <div class="chiller-info-grid">
                <div class="info-card"><p class="label">Status</p><p class="value running">{{ "Running" if data and data.Sys1_Comp_FLA is not none and data.Sys1_Comp_FLA > 5 else "Stopped" }}</p></div>
                <div class="info-card"><p class="label">Sys1 Comp FLA</p><p class="value">{{ data.Sys1_Comp_FLA if data and data.Sys1_Comp_FLA is not none else '-' }} %</p></div>
                <div class="info-card"><p class="label">Sys1 Run Hour</p><p class="value">{{ data.Sys1_Run_Hour if data and data.Sys1_Run_Hour is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">VSD Out Freq</p><p class="value">{{ data.Vsd_Out_Freq if data and data.Vsd_Out_Freq is not none else '-' }} Hz</p></div>
                <div class="info-card"><p class="label">Approach Evap</p><p class="value">{{ data.Approach_Evap if data and data.Approach_Evap is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Approach Cond</p><p class="value">{{ data.Approach_Cond if data and data.Approach_Cond is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Evap ΔT</p><p class="value">{{ data.Evap_DT if data and data.Evap_DT is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Cond ΔT</p><p class="value">{{ data.Cond_DT if data and data.Cond_DT is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Cooling Capacity</p><p class="value">{{ data.Cooling_Capacity if data and data.Cooling_Capacity is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Efficiency</p><p class="value">{{ data.Efficiency if data and data.Efficiency is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">COP</p><p class="value">{{ data.COP if data and data.COP is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">EER</p><p class="value">{{ data.EER if data and data.EER is not none else '-' }}</p></div>
            </div>
        </div>

        <div class="evap-cond-section">
            <div class="section-card">
                <p class="mb-4">Evaporator</p>
                <div class="flex flex-row space-x-4">
                    <div class="thermometer-group flex-1 flex flex-row space-x-4">
                        <div class="single-thermometer">
                            <p class="thermometer-label">Evap LWT</p>
                            <canvas data-type="linear-gauge" data-width="120" data-height="220" data-value="{{ data.Evap_LWT if data and data.Evap_LWT is not none else 0 }}" data-units="°C"></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Evap RWT</p>
                            <canvas data-type="linear-gauge" data-width="120" data-height="220" data-value="{{ data.Evap_RWT if data and data.Evap_RWT is not none else 0 }}" data-units="°C"></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Sys1 Evap Press</p>
                            <canvas data-type="radial-gauge" data-width="180" data-height="180" data-value="{{ data.Sys1_Evap_Press if data and data.Sys1_Evap_Press is not none else 0 }}" data-units="psi"></canvas>
                        </div>
                    </div>
                    <div class="data-table-container flex-1 p-4 rounded-md shadow-sm">
                        <h3 class="text-lg font-semibold mb-2 text-center">Detail Evaporator</h3>
                        <table class="parameter-table min-w-full">
                            <thead>
                                <tr>
                                    <th scope="col">Parameter</th>
                                    <th scope="col">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Evap LWT</td>
                                    <td>{{ data.Evap_LWT if data and data.Evap_LWT is not none else '-' }} °C</td>
                                </tr>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Evap RWT</td>
                                    <td>{{ data.Evap_RWT if data and data.Evap_RWT is not none else '-' }} °C</td>
                                </tr>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Sys1 Evap Press</td>
                                    <td>{{ data.Sys1_Evap_Press if data and data.Sys1_Evap_Press is not none else '-' }} psi</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <p class="mb-4">Condenser</p>
                <div class="flex flex-row space-x-4">
                    <div class="thermometer-group flex-1 flex flex-row space-x-4">
                        <div class="single-thermometer">
                            <p class="thermometer-label">Cond LWT</p>
                            <canvas data-type="linear-gauge" data-width="120" data-height="220" data-value="{{ data.Cond_LWT if data and data.Cond_LWT is not none else 0 }}" data-units="°C"></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Cond RWT</p>
                            <canvas data-type="linear-gauge" data-width="120" data-height="220" data-value="{{ data.Cond_RWT if data and data.Cond_RWT is not none else 0 }}" data-units="°C"></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">VSD In Amb Temp</p>
                            <canvas data-type="linear-gauge" data-width="120" data-height="220" data-value="{{ data.Vsd_In_Amb_Temp if data and data.Vsd_In_Amb_Temp is not none else 0 }}" data-units="°C"></canvas>
                        </div>
                    </div>
                    <div class="data-table-container flex-1 p-4 rounded-md shadow-sm">
                        <h3 class="text-lg font-semibold mb-2 text-center">Detail Kondensor</h3>
                        <table class="parameter-table min-w-full">
                            <thead>
                                <tr>
                                    <th scope="col">Parameter</th>
                                    <th scope="col">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Cond LWT</td>
                                    <td>{{ data.Cond_LWT if data and data.Cond_LWT is not none else '-' }} °C</td>
                                </tr>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Cond RWT</td>
                                    <td>{{ data.Cond_RWT if data and data.Cond_RWT is not none else '-' }} °C</td>
                                </tr>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">VSD In Amb Temp</td>
                                    <td>{{ data.Vsd_In_Amb_Temp if data and data.Vsd_In_Amb_Temp is not none else '-' }} °C</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="oil-discharge-section">
            <div class="section-card">
                <p class="mb-4">Oil & Discharge</p>
                <div class="flex flex-row space-x-4">
                    <div class="thermometer-group flex-1 flex flex-row space-x-4">
                        <div class="single-thermometer">
                            <p class="thermometer-label">Sys1 Disch Temp</p>
                            <canvas data-type="linear-gauge" data-width="120" data-height="220" data-value="{{ data.Sys1_Disch_Temp if data and data.Sys1_Disch_Temp is not none else 0 }}" data-units="°C"></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Sys1 Oil Press</p>
                            <canvas data-type="radial-gauge" data-width="180" data-height="180" data-value="{{ data.Sys1_Oil_Press if data and data.Sys1_Oil_Press is not none else 0 }}" data-units="psi"></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Sys1 Disch Press</p>
                            <canvas data-type="radial-gauge" data-width="180" data-height="180" data-value="{{ data.Sys1_Disch_Press if data and data.Sys1_Disch_Press is not none else 0 }}" data-units="psi"></canvas>
                        </div>
                    </div>
                    <div class="data-table-container flex-1 p-4 rounded-md shadow-sm">
                        <h3 class="text-lg font-semibold mb-2 text-center">Detail Oli & Discharge</h3>
                        <table class="parameter-table min-w-full">
                            <thead>
                                <tr>
                                    <th scope="col">Parameter</th>
                                    <th scope="col">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Sys1 Disch Temp</td>
                                    <td>{{ data.Sys1_Disch_Temp if data and data.Sys1_Disch_Temp is not none else '-' }} °C</td>
                                </tr>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Sys1 Oil Press</td>
                                    <td>{{ data.Sys1_Oil_Press if data and data.Sys1_Oil_Press is not none else '-' }} psi</td>
                                </tr>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Sys1 Disch Press</td>
                                    <td>{{ data.Sys1_Disch_Press if data and data.Sys1_Disch_Press is not none else '-' }} psi</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="chart-section">
            <h2 class="text-2xl font-bold text-white mb-4 text-center">Analisis Data Historis</h2>
            <form action="{{ url_for('test_halaman_yvwa1') }}" method="get">
                <div class="filter-form">
                    <div>
                        <label for="start_date">Dari Tanggal & Jam</label>
                        <input type="datetime-local" id="start_date" name="start_date" value="{{ start_date or '' }}">
                    </div>
                    <div>
                        <label for="end_date">Sampai Tanggal & Jam</label>
                        <input type="datetime-local" id="end_date" name="end_date" value="{{ end_date or '' }}">
                    </div>
                    <button type="submit">Tampilkan</button>
                    <button type="button" id="report-button" style="margin-left: 1rem;">Export PDF</button>
                </div>
            </form>
            {% if historical_data %}
            <div class="charts-grid">
                {% set chart_parameters = [
                    { "key": "Evap_LWT", "label": "Evap LWT", "unit": "°C" },
                    { "key": "Evap_RWT", "label": "Evap RWT", "unit": "°C" },
                    { "key": "Vsd_In_Amb_Temp", "label": "VSD In Amb Temp", "unit": "°C" },
                    { "key": "Cond_RWT", "label": "Cond RWT", "unit": "°C" },
                    { "key": "Cond_LWT", "label": "Cond LWT", "unit": "°C" },
                    { "key": "Sys1_Disch_Temp", "label": "Sys1 Disch Temp", "unit": "°C" },
                    { "key": "Sys1_Oil_Press", "label": "Sys1 Oil Press", "unit": "psi" },
                    { "key": "Sys1_Evap_Press", "label": "Sys1 Evap Press", "unit": "psi" },
                    { "key": "Sys1_Disch_Press", "label": "Sys1 Disch Press", "unit": "psi" },
                    { "key": "Sys1_Comp_FLA", "label": "Sys1 Comp FLA", "unit": "%" },
                    { "key": "Vsd_Out_Freq", "label": "VSD Out Freq", "unit": "Hz" },
                    { "key": "Approach_Evap", "label": "Approach Evap", "unit": "" },
                    { "key": "Approach_Cond", "label": "Approach Cond", "unit": "" },
                    { "key": "Evap_DT", "label": "Evap ΔT", "unit": "" },
                    { "key": "Cond_DT", "label": "Cond ΔT", "unit": "" },
                    { "key": "Cooling_Capacity", "label": "Cooling Capacity", "unit": "" },
                    { "key": "Efficiency", "label": "Efficiency", "unit": "" },
                    { "key": "COP", "label": "COP", "unit": "" },
                    { "key": "EER", "label": "EER", "unit": "" }
                ] %}
                {% for param in chart_parameters %}
                <div class="chart-card-wrapper">
                    <div class="chart-card">
                        <h3 class="chart-card-title">{{ param.label }}</h3>
                        <div class="chart-canvas-container">
                            <canvas id="chart-{{ param.key }}"></canvas>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center">
                <h3 class="text-xl font-semibold text-white">Data Grafik Tidak Tersedia</h3>
                <p class="text-gray-400 mt-2">Tidak ada data historis yang ditemukan untuk rentang waktu ini.</p>
            </div>
            {% endif %}
        </div>
        <div id="export-modal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Pilih Unit Laporan</h2>
                <p style="margin-bottom: 1.5rem;">Pilih unit temperatur untuk laporan PDF Anda.</p>
                <div class="modal-buttons">
                    <button id="export-celsius-btn">Export (°C)</button>
                    <button id="export-fahrenheit-btn">Export (°F)</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const historicalData = {{ historical_data|tojson }};
        const chartParameters = {{ chart_parameters | tojson }};
        let currentCharts = {};

        function renderCharts() {
            for (const chartId in currentCharts) {
                if (currentCharts[chartId]) {
                    currentCharts[chartId].destroy();
                }
            }
            currentCharts = {};

            if (historicalData && historicalData.length > 0) {
                const labels = historicalData.map(d => new Date(d.timestamp).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'medium' }));
                
                chartParameters.forEach(param => {
                    const ctx = document.getElementById(`chart-${param.key}`)?.getContext('2d');
                    if (!ctx) return;

                    const gradient = ctx.createLinearGradient(0, 0, 0, 250);
                    gradient.addColorStop(0, 'rgba(234, 179, 8, 0.4)');
                    gradient.addColorStop(1, 'rgba(234, 179, 8, 0)');
                    
                    const datasets = [{
                        label: param.label,
                        data: historicalData.map(d => d[param.key]),
                        borderColor: '#eab308',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointRadius: 2,
                        pointHoverRadius: 5,
                        pointBackgroundColor: '#eab308',
                        fill: true,
                        tension: 0.4
                    }];

                    currentCharts[param.key] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    display: false
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    backgroundColor: '#1f2937',
                                    titleColor: '#d1d5db',
                                    bodyColor: '#d1d5db',
                                    cornerRadius: 8,
                                    padding: 12,
                                    titleFont: { weight: 'bold' },
                                    bodyFont: { size: 14 },
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += context.parsed.y.toFixed(2) + ' ' + param.unit;
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { 
                                    ticks: { 
                                        display: true, 
                                        autoSkip: true,
                                        maxTicksLimit: 7,
                                        color: '#9ca3af'
                                    },
                                    grid: { display: false }
                                },
                                y: {
                                    beginAtZero: false,
                                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                                    ticks: { 
                                        color: '#9ca3af',
                                        maxTicksLimit: 5,
                                        callback: function(value) {
                                            return value.toFixed(2) + ' ' + param.unit;
                                        }
                                    }
                                }
                            }
                        }
                    });
                });
            }
        }

        renderCharts();

        const modal = document.getElementById('export-modal');
        const btn = document.getElementById('report-button');
        const span = document.getElementsByClassName('close-button')[0];
        const exportCelsiusBtn = document.getElementById('export-celsius-btn');
        const exportFahrenheitBtn = document.getElementById('export-fahrenheit-btn');

        function exportPdfWithUnit(unit) {
            const chillerId = "{{ chiller.id }}";
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            let reportUrl = `/report/pdf/${chillerId}`;
            const params = new URLSearchParams();
            if (startDate) { params.append('start_date', startDate); }
            if (endDate) { params.append('end_date', endDate); }
            params.append('unit', unit);
            if (params.toString()) { reportUrl += `?${params.toString()}`; }
            const win = window.open(reportUrl, '_blank');
            if (win) { win.onload = function() { win.print(); }; }
        }

        btn.onclick = function() {
            modal.style.display = "block";
        }
        span.onclick = function() {
            modal.style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
        exportCelsiusBtn.onclick = function() {
            exportPdfWithUnit('celsius');
            modal.style.display = "none";
        }
        exportFahrenheitBtn.onclick = function() {
            exportPdfWithUnit('fahrenheit');
            modal.style.display = "none";
        }
    });
</script>
{% endblock %}