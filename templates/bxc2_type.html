{% extends 'sidebar.html' %}

{% block title %}{{ chiller_name or 'Chiller Dashboard' }} - JTI BAS Dashboard{% endblock %}

{% block header_title %}{{ chiller_name or 'Chiller Dashboard' }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
  .value-cell.safe {
    color: #2ecc71; /* Green */
    font-weight: bold;
  }
  .value-cell.unsafe {
    color: #e74c3c; /* Red */
    font-weight: bold;
  }
  .icon-circle i {
    font-size: 24px;
    color: #fff;
  }
</style>
<div class="chiller-content-wrapper">
    <div class="dashboard-grid">
        <div class="last-updated-info">
            <p>Last Updated: {{ last_updated_timestamp.strftime("%Y-%m-%d %H:%M:%S") if last_updated_timestamp else 'N/A' }}</p>
            <div class="unit-selection">
                <label for="temp_unit">Temperature Unit:</label>
                <select id="temp_unit">
                    <option value="celsius">Celsius (°C)</option>
                    <option value="fahrenheit">Fahrenheit (°F)</option>
                </select>
            </div>
        </div>
        
        <div class="faults-section">
            
            <div class="fault-card {% if data.safety_fault and data.safety_fault > 0 %}blink-red{% endif %}">
                <div class="icon-circle"><i class="fas fa-shield-alt"></i></div>
                <div class="fault-details"><p class="fault-type">Safety Fault</p><p class="fault-value">{{ data.safety_fault_desc if data and data.safety_fault_desc is not none else '-' }}</p></div>
            </div>
            <div class="fault-card {% if data.cycling_fault and data.cycling_fault > 0 %}blink-yellow{% endif %}">
                <div class="icon-circle"><i class="fas fa-sync-alt"></i></div>
                <div class="fault-details"><p class="fault-type">Cycling Fault</p><p class="fault-value">{{ data.cycling_fault_desc if data and data.cycling_fault_desc is not none else '-' }}</p></div>
            </div>
            <div class="fault-card {% if data.warning_fault and data.warning_fault > 0 %}blink-yellow{% endif %}">
                <div class="icon-circle"><i class="fas fa-bell"></i></div>
                <div class="fault-details"><p class="fault-type">Warning Fault</p><p class="fault-value">{{ data.warning_fault_desc if data and data.warning_fault_desc is not none else '-' }}</p></div>
            </div>
            
        </div>

        <div class="chiller-details-section">
            <div class="chiller-image">
                {% if data and data.fla is not none and data.fla > 5 %}
                <img src="{{ url_for('static', filename='images/chiller-active.gif') }}" alt="Chiller Unit">
                {% else %}
                <img src="{{ url_for('static', filename='images/chiller.png') }}" alt="Chiller Unit">
                {% endif %}
            </div>
            <div class="chiller-info-grid">
                <div class="info-card"><p class="label">Status</p><p class="value running">{{ "Running" if data and data.fla is not none and data.fla > 5 else "Stopped" }}</p></div>
                <div class="info-card"><p class="label">FLA</p><p class="value">{{ data.fla if data and data.fla is not none else '-' }} %</p></div>
                <div class="info-card"><p class="label">Operating Hour</p><p class="value">{{ data.operating_hour if data and data.operating_hour is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Input Power</p><p class="value">{{ data.input_power if data and data.input_power is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Input KWh</p><p class="value">{{ data.input_kwh if data and data.input_kwh is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Starts</p><p class="value">{{ data.number_of_start if data and data.number_of_start is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">VSD PH A Current</p><p class="value">{{ data.vsd_ph_a_current if data and data.vsd_ph_a_current is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">VSD PH B Current</p><p class="value">{{ data.vsd_ph_b_current if data and data.vsd_ph_b_current is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">VSD PH C Current</p><p class="value">{{ data.vsd_ph_c_current if data and data.vsd_ph_c_current is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Approach Evap</p><p class="value">{{ data.Approach_Evap if data and data.Approach_Evap is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Approach Cond</p><p class="value">{{ data.Approach_Cond if data and data.Approach_Cond is not none else '-' }}</p></div>

                <div class="info-card"><p class="label">Evap ΔT</p><p class="value">{{ data.Evap_DT if data and data.Evap_DT is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Cond ΔT</p><p class="value">{{ data.Cond_DT if data and data.Cond_DT is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Cooling Capacity</p><p class="value">{{ data.Cooling_Capacity if data and data.Cooling_Capacity is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">Efficiency</p><p class="value">{{ data.efficiency if data and data.efficiency is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">COP</p><p class="value">{{ data.COP if data and data.COP is not none else '-' }}</p></div>
                <div class="info-card"><p class="label">EER</p><p class="value">{{ data.EER if data and data.EER is not none else '-' }}</p></div>
            </div>
        </div>

        

        <div class="evap-cond-section">
            <div class="section-card">
                <p class="mb-4">Evap</p>
                <div class="flex flex-row space-x-4">
                    <div class="thermometer-group flex-1 flex flex-row space-x-4">
                        <div class="single-thermometer">
                            <p class="thermometer-label">LWT</p>
                            <canvas
                                data-type="linear-gauge"
                                data-min-value="10"
                                data-max-value="80"
                                data-major-ticks="10, 20, 30, 40, 50, 60, 70, 80"
                                data-width="120"
                                data-height="220"
                                data-value="{{ data.evap_lwt if data and data.evap_lwt is not none else 0 }}"
                                data-units="°C"
                                data-original-value="{{ data.evap_lwt if data and data.evap_lwt is not none else 0 }}"
                                data-highlights='[{"from":5.5,"to":8.8,"color":"rgba(46,204,113,0.75)"}]'
                            ></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">RWT</p>
                            <canvas
                                data-type="linear-gauge"
                                data-min-value="10"
                                data-max-value="80"
                                data-major-ticks="10, 20, 30, 40, 50, 60, 70, 80"
                                data-width="120"
                                data-height="220"
                                data-value="{{ data.evap_rwt if data and data.evap_rwt is not none else 0 }}"
                                data-units="°C"
                                data-original-value="{{ data.evap_rwt if data and data.evap_rwt is not none else 0 }}"
                                data-min-value="0"
                                data-max-value="60"
                                data-highlights='[{"from":11.11,"to":14.44,"color":"rgba(46,204,113,0.75)"}]'
                            ></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Satur Temp</p>
                            <canvas
                                data-type="linear-gauge"
                                data-min-value="0"
                                data-max-value="100"
                                data-major-ticks="0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100"
                                data-width="120"
                                data-height="220"
                                data-value="{{ data.evap_satur_temp if data and data.evap_satur_temp is not none else 0 }}"
                                data-units="°C"
                                data-original-value="{{ data.evap_satur_temp if data and data.evap_satur_temp is not none else 0 }}"
                                data-highlights='[{"from":3.33,"to":6.67,"color":"rgba(46,204,113,0.75)"}]'
                            ></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Pressure</p>
                            <canvas
                                data-type="radial-gauge"
                                data-min-value="230"
                                data-max-value="520"
                                data-major-ticks="230, 250, 280, 330, 380, 430, 480, 520"
                                data-width="180"
                                data-height="180"
                                data-value="{{ data.evap_pressure if data and data.evap_pressure is not none else 0 }}"
                                data-units="psi"
                                data-highlights='[{"from":220.64,"to":275.8,"color":"rgba(46,204,113,0.75)"}]'
                            ></canvas>
                        </div>
                    </div>
                    <div class="data-table-container flex-1 p-4 rounded-md shadow-sm">
                        <h3 class="text-lg font-semibold mb-2 text-center">Detail Evaporator</h3>
                        <table class="parameter-table min-w-full">
                            <thead>
                                <tr>
                                    <th scope="col">Parameter</th>
                                    <th scope="col">Safe Range</th>
                                    <th scope="col">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="hover:bg-gray-700" data-param-key="evap_lwt">
                                    <td class="font-medium">LWT</td>
                                    <td data-safe-range-celsius-min="5.5" data-safe-range-celsius-max="8.8">5.50 - 8.80</td>
                                    <td data-temp-celsius="{{ data.evap_lwt if data and data.evap_lwt is not none else '' }}">{{ data.evap_lwt if data and data.evap_lwt is not none else '-' }} °C</td>
                                </tr>
                                <tr class="hover:bg-gray-700" data-param-key="evap_rwt">
                                    <td class="font-medium">RWT</td>
                                    <td data-safe-range-celsius-min="11.11" data-safe-range-celsius-max="14.44">11.11 - 14.44</td>
                                    <td data-temp-celsius="{{ data.evap_rwt if data and data.evap_rwt is not none else '' }}">{{ data.evap_rwt if data and data.evap_rwt is not none else '-' }} °C</td>
                                </tr>
                                <tr class="hover:bg-gray-700" data-param-key="evap_satur_temp">
                                    <td class="font-medium">Satur Temp</td>
                                    <td data-safe-range-celsius-min="3.33" data-safe-range-celsius-max="6.67">3.33 - 6.67</td>
                                    <td data-temp-celsius="{{ data.evap_satur_temp if data and data.evap_satur_temp is not none else '' }}">{{ data.evap_satur_temp if data and data.evap_satur_temp is not none else '-' }} °C</td>
                                </tr>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Pressure</td>
                                    <td>220.64 - 275.8</td>
                                    <td>{{ data.evap_pressure if data and data.evap_pressure is not none else '-' }} psi</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <p class="mb-4">Condenser</p>
                <div class="flex flex-row space-x-4">
                    <div class="thermometer-group flex-1 flex flex-row space-x-4">
                        <div class="single-thermometer">
                            <p class="thermometer-label">LWT</p>
                            <canvas
                                data-type="linear-gauge"
                                data-width="120"
                                data-height="220"
                                data-value="{{ data.cond_lwt if data and data.cond_lwt is not none else 0 }}"
                                data-units="°C"
                                data-original-value="{{ data.cond_lwt if data and data.cond_lwt is not none else 0 }}"
                                data-min-value="0"
                                data-max-value="60"
                                
                                data-highlights='[{"from":32.22,"to":35.55,"color":"rgba(46,204,113,0.75)"}]'
                            ></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">RWT</p>
                            <canvas
                                data-type="linear-gauge"
                                data-width="120"
                                data-height="220"
                                data-value="{{ data.cond_rwt if data and data.cond_rwt is not none else 0 }}"
                                data-units="°C"
                                data-original-value="{{ data.cond_rwt if data and data.cond_rwt is not none else 0 }}"
                                data-min-value="0"
                                data-max-value="60"
                                data-highlights='[{"from":26.67,"to":30.0,"color":"rgba(46,204,113,0.75)"}]'
                            ></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Satur Temp</p>
                            <canvas
                                data-type="linear-gauge"
                                data-width="120"
                                data-height="220"
                                data-min-value="10"
                                data-max-value="105"
                                data-major-ticks="10, 20, 30, 40, 50, 60, 70, 80,90, 105"
                                data-value="{{ data.cond_satur_temp if data and data.cond_satur_temp is not none else 0 }}"
                                data-units="°C"
                                data-original-value="{{ data.cond_satur_temp if data and data.cond_satur_temp is not none else 0 }}"
                                data-min-value="0"
                                data-max-value="60"
                                data-highlights='[{"from":32.22,"to":40.56,"color":"rgba(46,204,113,0.75)"}]'
                            ></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Pressure</p>
                            <canvas
                                data-type="radial-gauge"
                                data-width="180"
                                data-height="180"
                                data-value="{{ data.cond_pressure if data and data.cond_pressure is not none else 0 }}"
                                data-units="psi"
                                data-min-value="0"
                                data-max-value="1000"
                                data-major-ticks="0, 100, 200, 300, 400, 500, 600,700,800,900, 1000"
                                data-highlights='[{"from":723.9,"to":930.8,"color":"rgba(46,204,113,0.75)"}]'
                            ></canvas>
                        </div>
                    </div>
                    <div class="data-table-container flex-1 p-4 rounded-md shadow-sm">
                        <h3 class="text-lg font-semibold mb-2 text-center">Detail Kondensor</h3>
                        <table class="parameter-table min-w-full">
                            <thead>
                                <tr>
                                    <th scope="col">Parameter</th>
                                    <th scope="col">Safe Range</th>
                                    <th scope="col">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="hover:bg-gray-700" data-param-key="cond_lwt">
                                    <td class="font-medium">LWT</td>
                                    <td data-safe-range-celsius-min="32.22" data-safe-range-celsius-max="35.55">32.22 - 35.55</td>
                                    <td data-temp-celsius="{{ data.cond_lwt if data and data.cond_lwt is not none else '' }}">{{ data.cond_lwt if data and data.cond_lwt is not none else '-' }} °C</td>
                                </tr>
                                <tr class="hover:bg-gray-700" data-param-key="cond_rwt">
                                    <td class="font-medium">RWT</td>
                                    <td data-safe-range-celsius-min="26.67" data-safe-range-celsius-max="30.0">26.67 - 30.00</td>
                                    <td data-temp-celsius="{{ data.cond_rwt if data and data.cond_rwt is not none else '' }}">{{ data.cond_rwt if data and data.cond_rwt is not none else '-' }} °C</td>
                                </tr>
                                <tr class="hover:bg-gray-700" data-param-key="cond_satur_temp">
                                    <td class="font-medium">Satur Temp</td>
                                    <td data-safe-range-celsius-min="32.22" data-safe-range-celsius-max="40.56">32.22 - 40.56</td>
                                    <td data-temp-celsius="{{ data.cond_satur_temp if data and data.cond_satur_temp is not none else '' }}">{{ data.cond_satur_temp if data and data.cond_satur_temp is not none else '-' }} °C</td>
                                </tr>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Pressure</td>
                                    <td>723.9 - 930.8</td>
                                    <td>{{ data.cond_pressure if data and data.cond_pressure is not none else '-' }} psi</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="oil-discharge-section">
            <div class="section-card">
                <p class="mb-4">Oil & Discharge</p>
                <div class="flex flex-row space-x-4">
                    <div class="thermometer-group flex-1 flex flex-row space-x-4">
                        <div class="single-thermometer">
                            <p class="thermometer-label">Oil Pressure Diff</p>
                            <canvas
                                data-type="radial-gauge"
                                data-min-value="-5"
                                data-max-value="300"
                                data-major-ticks="-5, 30, 65, 100, 135, 170, 205, 240, 275, 300"
                                data-width="180"
                                data-height="180"
                                data-value="{{ data.oil_pressure_diff if data and data.oil_pressure_diff is not none else 0 }}"
                                data-units="psi"
                                data-highlights='[{"from":227.5,"to":275.8,"color":"rgba(46,204,113,0.75)"}]'
                            ></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Oil Pump Pressure</p>
                            <canvas
                                data-type="radial-gauge"
                                min-value="0"
                                data-max-value="1000"
                                data-major-ticks="0, 100, 200, 300, 400, 500, 600, 700, 800, 900, 1000"
                                data-width="180"
                                data-height="180"
                                data-value="{{ data.oil_pump_pressure if data and data.oil_pump_pressure is not none else 0 }}"
                                data-units="psi"
                            ></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Oil Sump Temp</p>
                            <canvas
                                data-type="linear-gauge"
                                data-min-value="0"
                                data-max-value="125"
                                data-major-ticks="0, 15, 30, 45, 60, 75, 90, 105, 120, 125"
                                data-width="120"
                                data-height="220"
                                data-value="{{ data.oil_sump_temp if data and data.oil_sump_temp is not none else 0 }}"
                                data-units="°C"
                                data-original-value="{{ data.oil_sump_temp if data and data.oil_sump_temp is not none else 0 }}"
                                data-highlights='[{"from":40.56,"to":53.89,"color":"rgba(46,204,113,0.75)"}]'
                            ></canvas>
                        </div>
                        <div class="single-thermometer">
                            <p class="thermometer-label">Discharge Temp</p>
                            <canvas
                                data-type="linear-gauge"
                                data-min-value="0"
                                data-max-value="120"
                                data-major-ticks="0, 12, 24, 36, 48, 60, 72, 84, 96, 108, 120"
                                data-width="120"
                                data-height="220"
                                data-value="{{ data.discharge_temp if data and data.discharge_temp is not none else 0 }}"
                                data-units="°C"
                                data-original-value="{{ data.discharge_temp if data and data.discharge_temp is not none else 0 }}"
                                data-min-value="0"
                                data-max-value="120"
                                data-highlights='[{"from":40.56,"to":53.89,"color":"rgba(46,204,113,0.75)"}]'
                            ></canvas>
                        </div>
                    </div>
                    <div class="data-table-container flex-1 p-4 rounded-md shadow-sm">
                        <h3 class="text-lg font-semibold mb-2 text-center">Detail Oli & Discharge</h3>
                        <table class="parameter-table min-w-full">
                            <thead>
                                <tr>
                                    <th scope="col">Parameter</th>
                                    <th scope="col">Safe Range</th>
                                    <th scope="col">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Oil Pressure Diff</td>
                                    <td>227.5 - 275.8</td>
                                    <td>{{ data.oil_pressure_diff if data and data.oil_pressure_diff is not none else '-' }} psi</td>
                                </tr>
                                 <tr class="hover:bg-gray-700">
                                    <td class="font-medium">Oil Pump Pressure</td>
                                    <td>-</td>
                                    <td>{{ data.oil_pump_pressure if data and data.oil_pump_pressure is not none else '-' }} psi</td>
                                </tr>
                                 <tr class="hover:bg-gray-700" data-param-key="oil_sump_temp">
                                    <td class="font-medium">Oil Sump Temp</td>
                                    <td data-safe-range-celsius-min="40.56" data-safe-range-celsius-max="53.89">40.56 - 53.89</td>
                                    <td data-temp-celsius="{{ data.oil_sump_temp if data and data.oil_sump_temp is not none else '' }}">{{ data.oil_sump_temp if data and data.oil_sump_temp is not none else '-' }} °C</td>
                                </tr>
                                 <tr class="hover:bg-gray-700" data-param-key="discharge_temp">
                                    <td class="font-medium">Discharge Temp</td>
                                    <td data-safe-range-celsius-min="40.56" data-safe-range-celsius-max="53.89">40.56 - 53.89</td>
                                    <td data-temp-celsius="{{ data.discharge_temp if data and data.discharge_temp is not none else '' }}">{{ data.discharge_temp if data and data.discharge_temp is not none else '-' }} °C</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="chart-section">
            <h2 class="text-2xl font-bold text-white mb-4 text-center">Analisis Data Historis</h2>
            <form action="{{ url_for('test') }}" method="get">
                <input type="hidden" name="chiller_id" value="{{ chiller.id }}">
                <div class="filter-form">
                    <div>
                        <label for="start_date">Dari Tanggal & Jam</label>
                        <input type="datetime-local" id="start_date" name="start_date" value="{{ start_date or '' }}">
                    </div>
                    <div>
                        <label for="end_date">Sampai Tanggal & Jam</label>
                        <input type="datetime-local" id="end_date" name="end_date" value="{{ end_date or '' }}">
                    </div>
                    <button type="submit">Tampilkan</button>
                    <button type="button" id="report-button" style="margin-left: 1rem;">Export PDF</button>
                </div>
            </form>
            {% if historical_data %}
            <div class="charts-grid">
                {% set chart_parameters = [
                    { "key": "evap_lwt", "label": "Evap LWT", "unit": "°C" },
                    { "key": "evap_rwt", "label": "Evap RWT", "unit": "°C" },
                    { "key": "evap_pressure", "label": "Evap Pressure", "unit": "kPa" },
                    { "key": "evap_satur_temp", "label": "Evap Sat. Temp", "unit": "°C" },
                    { "key": "cond_lwt", "label": "Cond LWT", "unit": "°C" },
                    { "key": "cond_rwt", "label": "Cond RWT", "unit": "°C" },
                    { "key": "cond_pressure", "label": "Cond Pressure", "unit": "kPa" },
                    { "key": "cond_satur_temp", "label": "Cond Sat. Temp", "unit": "°C" },
                    { "key": "fla", "label": "FLA", "unit": "%" },
                    { "key": "input_power", "label": "Input Power", "unit": "kW" },
                    { "key": "oil_sump_temp", "label": "Oil Sump Temp", "unit": "°C" },
                    { "key": "discharge_temp", "label": "Discharge Temp", "unit": "°C" },
                    { "key": "number_of_start", "label": "Starts", "unit": "" }
                ] %}
                {% for param in chart_parameters %}
                <div class="chart-card-wrapper">
                    <div class="chart-card">
                        <h3 class="chart-card-title">{{ param.label }}</h3>
                        <div class="chart-canvas-container">
                            <canvas id="chart-{{ param.key }}"></canvas>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center">
                <h3 class="text-xl font-semibold text-white">Data Grafik Tidak Tersedia</h3>
                <p class="text-gray-400 mt-2">Tidak ada data historis yang ditemukan untuk rentang waktu ini.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.2.1/chartjs-plugin-annotation.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const historicalData = {{ historical_data|tojson }};
        const chartParameters = {{ chart_parameters | tojson }};
        let currentCharts = {}; // To store chart instances for destruction

        const tempUnitSelect = document.getElementById('temp_unit');
        
        let currentUnit = localStorage.getItem('temperatureUnit') || 'celsius';
        tempUnitSelect.value = currentUnit;

        function getSafeRanges() {
            const ranges = {};
            document.querySelectorAll('tr[data-param-key]').forEach(row => {
                const key = row.dataset.paramKey;
                const rangeCell = row.children[1];
                
                if (key && rangeCell) {
                    const min = rangeCell.dataset.safeRangeCelsiusMin;
                    const max = rangeCell.dataset.safeRangeCelsiusMax;
                    if (min && max) {
                        ranges[key] = {
                            min: parseFloat(min),
                            max: parseFloat(max)
                        };
                    }
                }
            });
            return ranges;
        }

        const safeRanges = getSafeRanges();

        function celsiusToFahrenheit(celsius) {
            if (celsius === null || celsius === undefined || isNaN(celsius)) {
                return null;
            }
            return (celsius * 9/5) + 32;
        }

        function updateSafeRangesDisplay(unit) {
            document.querySelectorAll('td[data-safe-range-celsius-min]').forEach(rangeCell => {
                const minCelsius = parseFloat(rangeCell.dataset.safeRangeCelsiusMin);
                const maxCelsius = parseFloat(rangeCell.dataset.safeRangeCelsiusMax);

                if (isNaN(minCelsius) || isNaN(maxCelsius)) return;

                if (unit === 'fahrenheit') {
                    const minF = celsiusToFahrenheit(minCelsius).toFixed(2);
                    const maxF = celsiusToFahrenheit(maxCelsius).toFixed(2);
                    rangeCell.textContent = `${minF} - ${maxF}`;
                } else {
                    rangeCell.textContent = `${minCelsius.toFixed(2)} - ${maxCelsius.toFixed(2)}`;
                }
            });
        }

        function checkSafeRanges() {
            const currentUnit = localStorage.getItem('temperatureUnit') || 'celsius';

            document.querySelectorAll('.parameter-table tbody tr').forEach(row => {
                const rangeCell = row.children[1];
                const valueCell = row.children[2];

                if (!rangeCell || !valueCell) return;

                const valueText = valueCell.textContent.trim();
                const value = parseFloat(valueText);

                valueCell.classList.remove('safe', 'unsafe', 'value-cell');

                if (isNaN(value)) {
                    return;
                }
                
                const isTemp = valueCell.hasAttribute('data-temp-celsius');
                let min, max;

                if (isTemp) {
                    const minCelsius = rangeCell.dataset.safeRangeCelsiusMin;
                    const maxCelsius = rangeCell.dataset.safeRangeCelsiusMax;
                    if (!minCelsius || !maxCelsius) return;

                    min = parseFloat(minCelsius);
                    max = parseFloat(maxCelsius);

                    if (currentUnit === 'fahrenheit') {
                        min = celsiusToFahrenheit(min);
                        max = celsiusToFahrenheit(max);
                    }
                } else {
                    const rangeText = rangeCell.textContent.trim();
                    if (rangeText === '-') return;
                    [min, max] = rangeText.split('-').map(s => parseFloat(s.trim()));
                }

                if (isNaN(min) || isNaN(max)) return;

                valueCell.classList.add('value-cell');

                if (value >= min && value <= max) {
                    valueCell.classList.add('safe');
                } else {
                    valueCell.classList.add('unsafe');
                }
            });
        }

        function updateTemperatureDisplays(unit) {
            const tempElements = document.querySelectorAll('[data-temp-celsius]');
            tempElements.forEach(el => {
                const celsiusValue = parseFloat(el.dataset.tempCelsius);
                let displayValue = '-';
                let displayUnit = '';

                if (!isNaN(celsiusValue)) {
                    if (unit === 'fahrenheit') {
                        displayValue = celsiusToFahrenheit(celsiusValue).toFixed(2);
                        displayUnit = '°F';
                    } else {
                        displayValue = celsiusValue.toFixed(2);
                        displayUnit = '°C';
                    }
                }
                el.textContent = `${displayValue} ${displayUnit}`;
            });

            updateSafeRangesDisplay(unit);

            const gaugeCanvases = document.querySelectorAll('canvas[data-type="linear-gauge"]');
            gaugeCanvases.forEach(canvas => {
                const originalValue = parseFloat(canvas.dataset.originalValue);
                let newValue = originalValue;
                let newUnit = '°C';

                if (unit === 'fahrenheit') {
                    newValue = celsiusToFahrenheit(originalValue);
                    newUnit = '°F';
                }
                
                canvas.dataset.value = newValue !== null ? newValue.toFixed(2) : 0;
                canvas.dataset.units = newUnit;
            });

            if (window.drawAllGauges) {
                window.drawAllGauges();
            }

            checkSafeRanges();
        }

        function renderCharts() {
            for (const chartId in currentCharts) {
                if (currentCharts[chartId]) {
                    currentCharts[chartId].destroy();
                }
            }
            currentCharts = {};

            if (historicalData && historicalData.length > 0) {
                const labels = historicalData.map(d => new Date(d.timestamp).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'medium' }));
                
                chartParameters.forEach(param => {
                    const ctx = document.getElementById(`chart-${param.key}`)?.getContext('2d');
                    if (!ctx) return;

                    const safeRange = safeRanges[param.key];
                    const annotations = {};

                    if (safeRange) {
                        let yMin = safeRange.min;
                        let yMax = safeRange.max;

                        const isTemperature = ["evap_lwt", "evap_rwt", "evap_satur_temp", "cond_lwt", "cond_rwt", "cond_satur_temp", "oil_sump_temp", "discharge_temp"].includes(param.key);

                        if (isTemperature && currentUnit === 'fahrenheit') {
                            yMin = celsiusToFahrenheit(yMin);
                            yMax = celsiusToFahrenheit(yMax);
                        }

                        annotations.safeRangeBox = {
                            type: 'box',
                            yMin: yMin,
                            yMax: yMax,
                            backgroundColor: 'rgba(46, 204, 113, 0.2)',
                            borderColor: '#2ecc71',
                            borderWidth: 1
                        };
                    }

                    let datasets;
                    const isTemperature = ["evap_lwt", "evap_rwt", "evap_satur_temp", "cond_lwt", "cond_rwt", "cond_satur_temp", "oil_sump_temp", "discharge_temp"].includes(param.key);
                    let displayUnit = param.unit;

                    if (isTemperature && currentUnit === 'fahrenheit') {
                        displayUnit = '°F';
                    } else if (isTemperature && currentUnit === 'celsius') {
                        displayUnit = '°C';
                    }

                    if (param.datasets) {
                        datasets = param.datasets.map((ds) => {
                            const r = parseInt(ds.borderColor.slice(1, 3), 16);
                            const g = parseInt(ds.borderColor.slice(3, 5), 16);
                            const b = parseInt(ds.borderColor.slice(5, 7), 16);
                            const gradient = ctx.createLinearGradient(0, 0, 0, 250);
                            gradient.addColorStop(0, `rgba(${r}, ${g}, ${b}, 0.4)`);
                            gradient.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0)`);

                            return {
                                label: `${ds.label}`,
                                data: historicalData.map(d => {
                                    const value = d[ds.key];
                                    return isTemperature && currentUnit === 'fahrenheit' ? celsiusToFahrenheit(value) : value;
                                }),
                                borderColor: ds.borderColor,
                                backgroundColor: gradient,
                                borderWidth: 2,
                                pointRadius: 2,
                                pointHoverRadius: 5,
                                pointBackgroundColor: ds.borderColor,
                                fill: true,
                                tension: 0.4
                            };
                        });
                    } else {
                        const gradient = ctx.createLinearGradient(0, 0, 0, 250);
                        gradient.addColorStop(0, 'rgba(234, 179, 8, 0.4)');
                        gradient.addColorStop(1, 'rgba(234, 179, 8, 0)');
                        
                        datasets = [{
                            label: param.label,
                            data: historicalData.map(d => {
                                const value = d[param.key];
                                return isTemperature && currentUnit === 'fahrenheit' ? celsiusToFahrenheit(value) : value;
                            }),
                            borderColor: '#eab308',
                            backgroundColor: gradient,
                            borderWidth: 2,
                            pointRadius: 2,
                            pointHoverRadius: 5,
                            pointBackgroundColor: '#eab308',
                            fill: true,
                            tension: 0.4
                        }];
                    }

                    currentCharts[param.key] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    display: !!param.datasets,
                                    position: 'top',
                                    labels: {
                                        color: '#d1d5db',
                                        boxWidth: 12,
                                        padding: 20,
                                        font: {
                                            size: 14
                                        }
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    backgroundColor: '#1f2937',
                                    titleColor: '#d1d5db',
                                    bodyColor: '#d1d5db',
                                    cornerRadius: 8,
                                    padding: 12,
                                    titleFont: { weight: 'bold' },
                                    bodyFont: { size: 14 },
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += context.parsed.y.toFixed(2) + ' ' + displayUnit;
                                            }
                                            return label;
                                        }
                                    }
                                },
                                annotation: {
                                    annotations: annotations
                                }
                            },
                            scales: {
                                x: { 
                                    ticks: { 
                                        display: true, 
                                        autoSkip: true,
                                        maxTicksLimit: 7,
                                        color: '#9ca3af'
                                    },
                                    grid: { display: false }
                                },
                                y: {
                                    beginAtZero: false,
                                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                                    ticks: { 
                                        color: '#9ca3af',
                                        maxTicksLimit: 5,
                                        callback: function(value) {
                                            return value.toFixed(2) + ' ' + displayUnit;
                                        }
                                    }
                                }
                            }
                        }
                    });
                });
            }
        }

        renderCharts();
        updateTemperatureDisplays(currentUnit);

        tempUnitSelect.addEventListener('change', function() {
            currentUnit = this.value;
            localStorage.setItem('temperatureUnit', currentUnit);
            updateTemperatureDisplays(currentUnit);
            renderCharts();
        });

        document.getElementById('report-button').addEventListener('click', function(e) {
            e.preventDefault();
            const chillerId = document.querySelector('input[name="chiller_id"]').value;
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const unit = document.getElementById('temp_unit').value; // ambil unit yang dipilih

            // Ambil status alarm dari data yang sudah di-render ke halaman
            let alarm = 'none';
            {% if data %}
                {% if data.safety_fault and data.safety_fault > 0 %}
                    alarm = 'safety_fault';
                {% elif data.cycling_fault and data.cycling_fault > 0 %}
                    alarm = 'cycling_fault';
                {% elif data.warning_fault and data.warning_fault > 0 %}
                    alarm = 'warning_fault';
                {% endif %}
            {% endif %}

            let reportUrl = `/report/pdf/${chillerId}`;
            const params = new URLSearchParams();
            if (startDate) {
                params.append('start_date', startDate);
            }
            if (endDate) {
                params.append('end_date', endDate);
            }
            if (unit) {
                params.append('unit', unit);
            }
            if (alarm) {
                params.append('alarm', alarm);
            }

            if (params.toString()) {
                reportUrl += `?${params.toString()}`;
            }

            // Open PDF and trigger print
            const win = window.open(reportUrl, '_blank');
            if (win) {
                win.onload = function() {
                    win.print();
                };
            }
        });
    });
</script>
{% endblock %}
